<!-- 阅读进度条 -->
<div id="progress-bar"
  class="fixed top-0 left-0 h-1 z-50 bg-gradient-to-r from-brand-primary-100 to-brand-primary-900 transition-all duration-300"
  style="width: 0%;">
</div>

{{ if .Params.protect }}

<!-- 授权表单区域 -->
<div id="auth-form-section" class="max-w-md mx-auto my-8 p-6 bg-white rounded-xl shadow-md dark:bg-gray-800">
	
	<!-- 头部区域 -->
	<div class="text-center mb-8">
		<h1 class="text-[clamp(1.5rem,3vw,2rem)] font-bold text-gray-800 dark:text-white mb-2">内容授权验证</h1>
		<p class="text-gray-600 dark:text-gray-300">请输入授权码以访问受保护内容</p>
	</div>

	<!-- 表单内容区 -->
	<div class="space-y-6">
		<!-- 授权码输入框 -->
		<div class="space-y-2">
			<label for="auth-code-input" class="block text-sm font-medium text-gray-700 dark:text-gray-300">授权码</label>
			<input type="text" id="auth-code-input" placeholder="请输入获取的授权码"
				class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 dark:bg-gray-700 dark:border-gray-600 dark:text-white dark:placeholder-gray-400 transition-all">
		</div>

		<!-- 淘宝链接 -->
		<div class="text-center">
			<a href="https://lehuye.taobao.com" target="_blank"
				class="inline-block font-bold text-blue-600 hover:text-blue-800 dark:text-blue-400 dark:hover:text-blue-300 transition-colors">
				【淘宝获取授权码】
			</a>
		</div>

		<!-- 授权内容ID -->
		<div class="space-y-2">
			<label class="block text-sm font-medium text-gray-700 dark:text-gray-300">授权内容ID</label>
			<p id="auth-id" class="px-4 py-2 bg-gray-100 rounded-lg text-gray-800 dark:bg-gray-700 dark:text-gray-200">
				{{ .Params.uuid }}
			</p>
		</div>

		<!-- 验证按钮 -->
		<div>
			<button id="auth-submit-button" data-uuid="{{ .Params.uuid }}" onclick="validateAuthCode(this.dataset.uuid)"
				class="w-full inline-flex items-center justify-center gap-2 px-4 py-2 text-sm font-medium text-white bg-blue-600 rounded-lg shadow-sm hover:bg-blue-700 active:bg-blue-800 dark:bg-blue-700 dark:hover:bg-blue-600 dark:active:bg-blue-800 transition-all duration-200 ease-in-out focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2 dark:focus:ring-offset-gray-800">
				<svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"
					xmlns="http://www.w3.org/2000/svg">
					<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
				</svg>
				验证授权
			</button>
		</div>

		<!-- 页脚信息 -->
		<div class="text-center pt-4 border-t border-gray-200 dark:border-gray-700">
			<p class="text-xs text-gray-500 dark:text-gray-400">© 2025 验证系统 - 请确保已获取合法授权</p>
		</div>
	</div>
</div>
<!-- 受保护内容区域 -->
<div id="protected-content-section" style="display:none;">
	<button data-uuid="{{ .Params.uuid }}" onclick="outValidateAuthCode(this.dataset.uuid)" class="inline-flex items-center gap-2 px-3 py-1.5 text-xs font-medium 
               text-red-600 bg-red-50 rounded               border border-red-200 rounded-full 
               hover:bg-red-100 hover:border-red-300
               dark:bg-red-900/15 dark:text-red-400 
               dark:border-red-800/50 dark:hover:bg-red-900/30
               transition-all duration-200
               focus:outline-none focus:ring-1.5 focus:ring-red-500
               whitespace-nowrap">
		<svg class="w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24"
			xmlns="http://www.w3.org/2000/svg">
			<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
				d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1"></path>
		</svg>
		退出授权 {{.Params.uuid}}
	</button>
	<div id="protect-article">
		{{ partial "blog/post-content.html" . }}
	</div>
</div>


{{ else }}

<!-- 不受保护的内容 -->
<div>
	{{ partial "blog/post-content.html" . }}
</div>

{{ end }}

<script>

	// 授权验证脚本
	async function validateAuthCode(authCode) {
		console.log('开始验证授权码...', authCode, document.getElementById('auth-code-input').value);

		// 从 localStorage 读取数据
		let authData = localStorage.getItem(authCode);
		if (!authData) {
			console.log('未找到授权数据，创建新的授权数据...');
			authData = {
				authorized: null,
				progress: 0,
				lastAccess: 0
			};
			localStorage.setItem(authCode, JSON.stringify(authData));
		} else {
			authData = JSON.parse(authData);
			console.log('已存在授权数据:', authData);
		}

		try {
			const response = await fetch("https://handle.lehuye.com/portals/verify-payment-order", {
				method: "POST",
				headers: {
					"Content-Type": "application/json",
					"authorization": "keebone"
				},
				body: JSON.stringify({
					code_order: authCode,       // 授权码作为唯一标识
					payment_order: document.getElementById('auth-code-input').value,     // 如果你的接口区分可调整
				})
			});

			if (!response.ok) {
				throw new Error(`网络响应异常: ${response.status}`);
			}

			const data = await response.json();
			console.log('远程验证返回:', data);

			// 更新授权状态
			authData.authorized = data.success;
			authData.lastAccess = Date.now();
			localStorage.setItem(authCode, JSON.stringify(authData));

			if (data.success) {
				console.log('授权验证成功');
				alert("授权成功！");
				window.location.reload();
				document.getElementById('auth-form-section').style.display = 'none';
				document.getElementById('protected-content-section').style.display = 'block';
			} else {
				console.warn('授权验证失败');
				alert("授权失败：授权码不匹配。");
			}

			return data.success;
		} catch (err) {
			console.error('请求错误:', err);
			alert('发生错误：' + err.message);
			return false;
		}
	}



	// 退出授权
	function outValidateAuthCode(uuid) {
		console.log('开始退出授权...', uuid);
		const authData = localStorage.getItem(uuid);
		//将authorized改为false其它不变
		if (authData) {
			const authDataObj = JSON.parse(authData);
			authDataObj.authorized = false;
			localStorage.setItem(uuid, JSON.stringify(authDataObj));
			window.location.reload();
			document.getElementById('auth-form-section').style.display = 'block';
			document.getElementById('protect-article').remove();
		}
	}


	document.addEventListener('DOMContentLoaded', function () {

		const progressBar = document.getElementById('progress-bar');
		if (!progressBar) return;

		const articleUuid = "{{ with .Params.uuid }}{{ . }}{{ end }}";
		console.log('当前文章UUID:', articleUuid);

		// 初始化：读取并处理数据（兼容旧数据，若有ISO字符串则转为时间戳）
		let savedData = null;
		try {
			const savedDataStr = localStorage.getItem(articleUuid);

			// 如果saveDataStr中的authorized为true时
			const josnStorage = JSON.parse(savedDataStr);

			if (josnStorage && josnStorage.authorized) {
				document.getElementById('auth-form-section').style.display = 'none';
				document.getElementById('protected-content-section').style.display = 'block';
			} else if (josnStorage && josnStorage.authorized === false) {
				document.getElementById('protect-article').remove();

			} else if (josnStorage && josnStorage.authorized === null) {
				window.location.reload();
			}


			if (typeof savedDataStr === 'string' && savedDataStr.trim() !== '') {
				savedData = JSON.parse(savedDataStr);
				// 兼容处理：若旧数据是ISO字符串，转为时间戳
				if (typeof savedData.lastAccess === 'string') {
					savedData.lastAccess = new Date(savedData.lastAccess).getTime();
				}
			}
		} catch (e) {
			console.warn('初始化解析数据失败，清除错误数据:', e);
			localStorage.removeItem(articleUuid);
			savedData = null;
		}

		initProgressBar(articleUuid, savedData);
		localArticleProgress(articleUuid, savedData);
	});

	// 读取进度（无改动，仅使用时间戳字段）
	function localArticleProgress(storageKey, savedData) {
		const progressBar = document.getElementById('progress-bar');
		if (!progressBar) return;

		try {
			const progress = savedData?.progress ?? 0;
			console.log('读取进度：', storageKey, savedData, '上次进度：', progress);
			progressBar.style.width = `${Math.min(progress, 100)}%`;



			// 3. 关键：根据历史进度计算滚动高度并定位
			if (progress > 0) { // 只有进度>0时才自动定位（避免首次访问滚动到顶部）
				// 计算文档可滚动总高度（文档高度 - 视口高度）
				const docHeight = document.body.offsetHeight - window.innerHeight;
				const scrollTop = (progress / 100) * docHeight;

				window.scrollTo({
					top: scrollTop,
					behavior: 'smooth'
				});
			}


		} catch (e) {
			console.error('读取进度失败:', e);
			progressBar.style.width = '0%';
		}
	}

	// 初始化滚动监听（无改动）
	function initProgressBar(storageKey) {
		const progressBar = document.getElementById('progress-bar');
		const savedDataStr = localStorage.getItem(storageKey);
		console.log('初始化进度条监听:', storageKey, savedDataStr);
		if (!progressBar) return;

		window.addEventListener('scroll', function () {
			const scrollTop = window.pageYOffset;
			const docHeight = document.body.offsetHeight - window.innerHeight;
			const scrollPercent = docHeight > 0 ? (scrollTop / docHeight) * 100 : 0;

			progressBar.style.width = `${scrollPercent}%`;
			saveReadingProgress(storageKey, scrollPercent);
		});
	}

	// 保存进度：关键修改——lastAccess改为时间戳
	function saveReadingProgress(storageKey, progress) {
		try {
			// 读取已有数据
			const savedDataStr = localStorage.getItem(storageKey);
			const savedData = savedDataStr
				? JSON.parse(savedDataStr)
				: { authorized: false, progress: 0, lastAccess: 0 }; // 默认时间戳0

			// 构造新数据：lastAccess用Date.getTime()获取13位时间戳
			const progressData = {
				...savedData,
				progress: Math.min(progress, 100),
				lastAccess: new Date().getTime() // 核心修改：存储毫秒级时间戳
			};

			// 验证并保存标准JSON
			const goodJson = JSON.stringify(progressData);
			JSON.parse(goodJson); // 二次验证格式
			localStorage.setItem(storageKey, goodJson);

			// console.log('保存进度成功:', progressData);
		} catch (e) {
			console.error('保存进度失败:', e);
		}
	}
</script>