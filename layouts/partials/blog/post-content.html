<!-- 阅读进度条 -->
<div id="progress-bar"
  class="fixed top-0 left-0 h-1 z-50 bg-gradient-to-r from-brand-primary-100 to-brand-primary-900 transition-all duration-300"
  style="width: 0%;">
</div>

<!-- 主内容容器 -->
<div class="protect-content bg-custom-bg-color p-8 rounded-2xl shadow-lg max-w-4xl mx-auto mt-8 transition-colors duration-300">

  <!-- 标题区域 -->
  <header class="mb-6">
    <!-- Title -->
    <h1
      class="text-3xl sm:text-4xl md:text-5xl font-extrabold text-primary leading-tight tracking-tight">
      {{ .Title }}
    </h1>

    <!-- UUID -->
    {{ with .Params.uuid }}
    <h6
      class="mt-2 inline-block bg-neutral text-xs font-mono px-2 py-1 rounded text-accent select-all">
      {{ . }}
    </h6>
    {{ end }}

    <!-- Date -->
    {{ with .Date }}
    {{ $dateMachine := . | time.Format "2006-01-02T15:04:05-07:00" }}
    {{ $dateHuman := . | time.Format ":date_long" }}
    <time datetime="{{ $dateMachine }}"
      class="mt-3 block text-sm text-secondary italic">
      {{ $dateHuman }}
    </time>
    {{ end }}
  </header>

  <!-- 正文内容 -->
  <article
    id="article-content"
    class="markdown-body markdown-content reading-container prose prose-lg max-w-none font-sans text-primary leading-relaxed transition-colors duration-300">
    
    {{/* 目录 (可选) */}}
    {{ if eq .Params.toc "true" }}
      {{ partial "toc.html" . }}
    {{ end }}

    {{ .Content }}
  </article>

  <!-- 标签与评论 -->
  <footer class="mt-10 border-t border-neutral pt-6 transition-colors duration-300">
    {{ partial "taxonomy-tags.html" . }}
    {{ partial "comments.html" (dict "uuid" .Params.uuid "Sitetitle" .Site.Title) }}
  </footer>

</div>

<script> 
document.addEventListener('DOMContentLoaded', function () {
  const progressBar = document.getElementById('progress-bar');
  if (!progressBar) return;

  const articleUuid = "{{ with .Params.uuid }}{{ . }}{{ end }}";
  console.log('当前文章UUID:', articleUuid);

  // 初始化：读取并处理数据（兼容旧数据，若有ISO字符串则转为时间戳）
  let savedData = null;
  try {
    const savedDataStr = localStorage.getItem(articleUuid);
    if (typeof savedDataStr === 'string' && savedDataStr.trim() !== '') {
      savedData = JSON.parse(savedDataStr);
      // 兼容处理：若旧数据是ISO字符串，转为时间戳
      if (typeof savedData.lastAccess === 'string') {
        savedData.lastAccess = new Date(savedData.lastAccess).getTime();
      }
    }
  } catch (e) {
    console.warn('初始化解析数据失败，清除错误数据:', e);
    localStorage.removeItem(articleUuid);
    savedData = null;
  }

  initProgressBar(articleUuid, savedData);
  localArticleProgress(articleUuid, savedData);
});

// 读取进度（无改动，仅使用时间戳字段）
function localArticleProgress(storageKey, savedData) {
  const progressBar = document.getElementById('progress-bar');
  if (!progressBar) return;

  try {
    const progress = savedData?.progress ?? 0;
  console.log('读取进度：', storageKey,savedData, '上次进度：', progress);
    progressBar.style.width = `${Math.min(progress, 100)}%`;



// 3. 关键：根据历史进度计算滚动高度并定位
    if (progress > 0) { // 只有进度>0时才自动定位（避免首次访问滚动到顶部）
      // 计算文档可滚动总高度（文档高度 - 视口高度）
      const docHeight = document.body.offsetHeight - window.innerHeight;
      const scrollTop = (progress / 100) * docHeight;

      window.scrollTo({
        top: scrollTop,
        behavior: 'smooth'
      });
    }


  } catch (e) {
    console.error('读取进度失败:', e);
    progressBar.style.width = '0%';
  }
}

// 初始化滚动监听（无改动）
function initProgressBar(storageKey) {
  const progressBar = document.getElementById('progress-bar');
  if (!progressBar) return;

  window.addEventListener('scroll', function () {
    const scrollTop = window.pageYOffset;
    const docHeight = document.body.offsetHeight - window.innerHeight;
    const scrollPercent = docHeight > 0 ? (scrollTop / docHeight) * 100 : 0;

    progressBar.style.width = `${scrollPercent}%`;
    saveReadingProgress(storageKey, scrollPercent);
  });
}

// 保存进度：关键修改——lastAccess改为时间戳
function saveReadingProgress(storageKey, progress) {
  try {
    // 读取已有数据
    const savedDataStr = localStorage.getItem(storageKey);
    const savedData = savedDataStr 
      ? JSON.parse(savedDataStr) 
      : { authorized: false, progress: 0, lastAccess: 0 }; // 默认时间戳0

    // 构造新数据：lastAccess用Date.getTime()获取13位时间戳
    const progressData = {
      ...savedData,
      progress: Math.min(progress, 100),
      lastAccess: new Date().getTime() // 核心修改：存储毫秒级时间戳
    };

    // 验证并保存标准JSON
    const goodJson = JSON.stringify(progressData);
    JSON.parse(goodJson); // 二次验证格式
    localStorage.setItem(storageKey, goodJson);

    console.log('保存进度成功:', progressData);
  } catch (e) {
    console.error('保存进度失败:', e);
  }
}
</script>